<?php
session_start(); require_once __DIR__.'/../../config/db.php'; require_once __DIR__.'/../../helpers/audit_fields.php'; require_once __DIR__.'/../../helpers/audit.php';
$admin=$_SESSION['admin_id']??null; if(!$admin){ $_SESSION['alert']=['type'=>'danger','message'=>'Not authenticated']; header('Location: ../../pages/delivery.php'); exit;}
$a=audit_on_create($admin); $s=$conn->prepare("INSERT INTO delivery (customer_id,delivery_date,dr_no,truck_id,billing_date,material,quantity,unit_price,status,is_deleted,date_created,date_edited,created_by,edited_by) VALUES (:customer_id,:delivery_date,:dr_no,:truck_id,:billing_date,:material,:quantity,:unit_price,:status,0,:date_created,:date_edited,:created_by,:edited_by)");
$s->execute([':customer_id'=>$_POST['customer_id']?:null,':delivery_date'=>$_POST['delivery_date'],':dr_no'=>$_POST['dr_no'],':truck_id'=>$_POST['truck_id']?:null,':billing_date'=>$_POST['billing_date'],':material'=>$_POST['material'],':quantity'=>$_POST['quantity'],':unit_price'=>$_POST['unit_price'],':status'=>$_POST['status']??'pending',':date_created'=>$a['date_created'],':date_edited'=>$a['date_edited'],':created_by'=>$a['created_by'],':edited_by'=>$a['edited_by']]);
$id=$conn->lastInsertId(); audit_log('delivery',$id,'CREATE',null,$_POST,$admin); $_SESSION['alert']=['type'=>'success','message'=>'Delivery created']; header('Location: ../../pages/delivery.php'); exit;
